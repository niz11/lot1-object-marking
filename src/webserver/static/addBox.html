<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Add Box</title>
</head>
<body>
<div id="displayblocks">
    <div style="display: table; padding: 2em;">
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">Name:</div>
            <div style="display: table-cell; padding: 1em;"><input type="text" id="name" placeholder="Name of Box"></div>
        </div>
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">Width (in m):</div>
            <div style="display: table-cell; padding: 1em;"><input type="number" id="width" value="1.0"></div>
        </div>
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">Height (in m):</div>
            <div style="display: table-cell; padding: 1em;"><input type="number" id="height" value="1.0"></div>
        </div>
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">Depth (in m):</div>
            <div style="display: table-cell; padding: 1em;"><input type="number" id="depth" value="1.0"></div>
        </div>
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">Distance (in m):</div>
            <div style="display: table-cell; padding: 1em;"><input type="number" id="mdist" value="0.0"></div>
        </div>
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">relative rotation (in deg):</div>
            <div style="display: table-cell; padding: 1em;"><input type="number" id="mrot" value="0.0"></div>
        </div>
        <div style="display: table-row; padding: 1em;">
            <div style="display: table-cell; padding: 1em;">Scaling:</div>
            <div style="display: table-cell; padding: 1em;"><input type="number" id="mscal" value="1.0"></div>
        </div>
        <div style="display: flex; justify-content: center; padding: 1em;">
            <div style="display: table-cell; padding: 1em;"></div>
            <button onclick="createBox()">Create Box</button>
        </div>
    </div>
</div>

<script type="module">
    import * as THREE from './new/three.module.js'
    import {GLTFExporter} from "./new/GLTFExporter.js";

    const link = document.createElement('a');
    link.style.display = 'none';
    document.body.appendChild(link);

    window.createBox = function createBox() {
        let name = document.getElementById("name").value;
        let width = +document.getElementById("width").value;
        let height = +document.getElementById("height").value;
        let depth = +document.getElementById("depth").value;
        let dist = +document.getElementById("mdist").value;
        let rot = +document.getElementById("mrot").value;
        let scal = +document.getElementById("mscal").value;

        rot = rot / 180 * Math.PI;

        let mesh = new THREE.Mesh(
            new THREE.BoxGeometry(width, height, depth),
            new THREE.MeshBasicMaterial({color: 0x0000ff}) //blue
        );
        mesh.material.wireframe = true;

        let exporter = new GLTFExporter();
        exporter.parse(mesh, function (json){
            const output = JSON.stringify(json, null, 2);
            const blob = new Blob([output], {type: 'text/plain'})
            link.href = URL.createObjectURL(blob);
            link.download = name + '.gltf';
            link.click();

            createDBEntry();
        })

        function createDBEntry(){
            console.log(JSON.stringify({
                src: "./ar/models/" + name + ".gltf",
                modelName: name,
                alt: name,
                longitude: 0,
                latitude: 0,
                distance: dist,
                rotation: rot,
                scaling: scal,
            }))
            fetch('/models/add-model',
                {
                    method: 'post',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        src: "./ar/models/" + name + ".gltf",
                        modelName: name,
                        alt: name,
                        longitude: '' + 0,
                        latitude: '' + 0,
                        distance: '' + dist,
                        rotation: '' + rot,
                        scaling: '' + scal,
                    })
                }
            ).catch(e => {
                console.log(e);
            })
        }
    }
</script>
</body>
</html>